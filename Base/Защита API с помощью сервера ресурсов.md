2023-02-0921:19
Tags: #Java #SpringFramework #SpringBoot #RESTful #SpringSecurity #OAuth2 

__
# Защита API с помощью сервера ресурсов

Сервер ресурсов - фильт перед API, проверяющий наличие действительного токена доступа с необходимой областью действия в запросах к ресурсам, требующим авторизации. 

Spring Security предоставляет свою реализацию сервера ресурсов OAuth2, которую можно добавить в существующий API, включив зависимость:
![[Pasted image 20230209212947.png]]


Следующим шагом нужно объявить, что для обработки запросов **POST** к конечной точке **/ingredients** требуется требуется область **writeIngredients**, а для обработки **DELETE** к **/ingredient** нужна область **deleteIngredients**:
```java
@Override
protected void configure(HttpSecurity http) throws Exception {
	http.
		authorizeRequests()
		
		...
		
		.antMatchers(HttpMethod.POST, "/api/ingredients")
			.hasAuthority("SCOPE_writeIngredients")
		.antMatchers(HttpMethod.DELETE, "/api/ingredients")
			.hasAuthority("SCOPE_deleteIngredients")
		
		...
}
```
Для каждой из конечных точек вызывается метод **hasAuthority()**, чтобы задать требуемую область действия. Стоит обратить внимание , что области имеют префикс *SCOPE_*, потому что они должны соотвествовать правилам OAuth2, указанным в токенах доступа в запросах к этим ресурсам.

В этом же классе нужно активизировать **сервер ресурсов**:
```java
@Override
protected void configure(HttpSecurity http) throws Exception {
	http.

	...

		.and()
	.oauth2ResourceServer(oauth2 -> oauth2.jwt())

	...
}
```
Здесь вызов в *oauth2ResourceServer()* передается лямбда-выражение, настраивающее сервер ресурсов. В данном случае оно просто включает поддержку токенов JWT, чтобы сервер ресурсов мог проверить содержимое токена и определить имеющиеся разрешения.

В частности, он будет проверять наличие в токене области *writeIngredients* и/или *deleteIngreidents* в двух конечных точках, которые мы защитили.

Однако сервер ресурсов не будет слепо верить самому факту наличия токена. Чтобы проверить, что токен реально создан проверенным сервером от имени пользователя, он будет проверять подпись токена с помощью открытого ключа, соответсвующего закрытому ключу, который использовался для создания подписи токена.

Однако мы должны помочь серверу понять где получить открытый ключ. Следующее свойство определяет URL сервера а вторизации, обратившись к которому, сервер ресурсов сможет получать открытый ключ:
```java
spring:
	security:
		oauth2:
			jwt:
				jwt-set-uri: http://localhost:9000/oauth/jwks
```

Теперь сервер ресурсов готов к работе!
__
### Zero-Links
- [[Безопасность REST API]]

__
### Links
- 

